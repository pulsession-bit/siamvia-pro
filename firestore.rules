rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Authentification de base
    function isAuthenticated() {
      return request.auth != null;
    }

    // Vérification Staff (Rôle existant)
    function hasStaffAccess() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role != null;
    }
    
    // Vérification Admin
    function isNexusMaster() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isNexusMaster == true;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    // --- NOUVEAU : Backdoor sécurisée pour votre email ---
    function isSystemAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'admin@siamvisa.pro' || 
              request.auth.token.email == 'pulsession@gmail.com');
    }

    // --- RÈGLES ---

    // USERS : On autorise SystemAdmin à se créer/modifier lui-même
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isNexusMaster() || isSystemAdmin());
      allow create: if isAuthenticated() && 
                       (hasRole('SUPER_ADMIN') || hasRole('NEXUS_MASTER') || (isSystemAdmin() && request.auth.uid == userId));
      allow update: if isAuthenticated() && 
                       (request.auth.uid == userId || hasRole('SUPER_ADMIN') || isNexusMaster() || isSystemAdmin());
      allow delete: if isNexusMaster() || isSystemAdmin();
    }

    // LEADS & CUSTOMERS & SESSIONS : Staff OU SystemAdmin
    match /leads/{leadId} {
      allow read, update, delete: if hasStaffAccess() || isSystemAdmin();
      allow create: if true;
    }
    
    match /customers/{customerId} {
      allow read, update, delete: if hasStaffAccess() || isSystemAdmin();
      allow create: if true;
    }
    
    match /sessions/{sessionId} {
      allow read, update, delete: if hasStaffAccess() || isSystemAdmin();
      allow create: if true;
    }

    // APPOINTMENTS
    match /appointments/{appointmentId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if hasStaffAccess() || isSystemAdmin();
    }

    // TICKETS
    match /tickets/{ticketId} {
      allow read, update: if isAuthenticated() && (isNexusMaster() || isSystemAdmin() || resource.data.siteId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.allowedSiteIds);
      allow create: if isAuthenticated();
      allow delete: if isNexusMaster() || isSystemAdmin();
    }

    // VISA APPLICATIONS (Demandes de visa)
    match /visa_applications/{applicationId} {
      allow create: if true; // Public form submission
      allow read, update, delete: if hasStaffAccess() || isSystemAdmin();
    }

    // INGRESS EVENTS (Événements d'ingestion - Server-side only)
    // Ces événements sont créés par des scripts backend/Cloud Functions
    match /ingress_events/{eventId} {
      allow read: if hasStaffAccess() || isSystemAdmin();
      allow create, update, delete: if isSystemAdmin(); // Only backend/admin can write
    }
  }
}
